name: AI Governance Gate

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  validate:
    name: "${{ matrix.scenario.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: "Compliant"
            kitfile: fraud-detection-compliant.yaml
            should_pass: true
          - name: "Bias"
            kitfile: fraud-detection-bias-violation.yaml
            should_pass: false
          - name: "Expired"
            kitfile: fraud-detection-expired-approval.yaml
            should_pass: false
          - name: "License"
            kitfile: fraud-detection-license-violation.yaml
            should_pass: false

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Kit CLI
        uses: jozu-ai/gh-kit-setup@v1.0.0
      
      - name: Pack ModelKit
        run: |
          cd model-artifacts
          cp ../kitfile-examples/${{ matrix.scenario.kitfile }} ./Kitfile
          kit pack . -t local/fraud:${{ github.sha }}
          kit inspect local/fraud:${{ github.sha }}
      
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
      
      - name: Validate Policies
        id: policy
        run: |
          FAIL=0
          
          # Test license policy
          if ! opa eval --data policies/license-compliance.rego \
              --input kitfile-examples/${{ matrix.scenario.kitfile }} \
              --format pretty "data.governance.licenses.deny" | grep -q "^\[\]$\|undefined"; then
            FAIL=1
            echo "::error::License policy failed"
          fi
          
          # Test approval policy
          if ! opa eval --data policies/approval-validation.rego \
              --input kitfile-examples/${{ matrix.scenario.kitfile }} \
              --format pretty "data.governance.approvals.deny" | grep -q "^\[\]$\|undefined"; then
            FAIL=1
            echo "::error::Approval policy failed"
          fi
          
          # Test bias policy
          if ! opa eval --data policies/bias-monitoring.rego \
              --input kitfile-examples/${{ matrix.scenario.kitfile }} \
              --format pretty "data.governance.bias.deny" | grep -q "^\[\]$\|undefined"; then
            FAIL=1
            echo "::error::Bias policy failed"
          fi
          
          echo "result=$([ $FAIL -eq 0 ] && echo PASS || echo FAIL)" >> $GITHUB_OUTPUT
      
      - name: Authenticate to Jozu Hub
        if: steps.policy.outputs.result == 'PASS' && matrix.scenario.should_pass
        env:
          JOZU_USERNAME: ${{ secrets.JOZU_USERNAME }}
          JOZU_PASSWORD: ${{ secrets.JOZU_PASSWORD }}
        run: |
          # Login to Jozu Hub using Kit CLI
          echo "$JOZU_PASSWORD" | kit login jozu.ml -u "$JOZU_USERNAME" --password-stdin
      
      - name: Push to Jozu Hub
        if: steps.policy.outputs.result == 'PASS' && matrix.scenario.should_pass
        run: |
          # Retag for Jozu Hub
          kit tag local/fraud:${{ github.sha }} jozu.ml/arnabchat2001/kitops-governance-demo:${{ github.sha }}
          kit tag local/fraud:${{ github.sha }} jozu.ml/arnabchat2001/kitops-governance-demo:latest
          
          # Push to Jozu Hub
          kit push jozu.ml/arnabchat2001/kitops-governance-demo:${{ github.sha }}
          kit push jozu.ml/arnabchat2001/kitops-governance-demo:latest
          
          echo "ModelKit pushed to Jozu Hub"
          echo "View at: https://jozu.ml/arnabchat2001/kitops-governance-demo"
      
      - name: Verify Demo
        run: |
          EXPECTED="${{ matrix.scenario.should_pass && 'PASS' || 'FAIL' }}"
          ACTUAL="${{ steps.policy.outputs.result }}"
          [ "$EXPECTED" = "$ACTUAL" ] || exit 1
