name: AI Governance Gate

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    name: "${{ matrix.scenario.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - name: "Pass - Compliant Model"
            kitfile: fraud-detection-compliant.yaml
          - name: "Block - Bias Violation"
            kitfile: fraud-detection-bias-violation.yaml
          - name: "Block - Expired Approval"
            kitfile: fraud-detection-expired-approval.yaml
          - name: "Block - License Violation"
            kitfile: fraud-detection-license-violation.yaml

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Kit CLI
        uses: jozu-ai/gh-kit-setup@v1.0.0
      
      - name: Pack ModelKit
        run: |
          cd model-artifacts
          cp ../kitfile-examples/${{ matrix.scenario.kitfile }} ./Kitfile
          kit pack . -t local/fraud:${{ github.sha }}
          kit inspect local/fraud:${{ github.sha }}
      
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
      
      - name: Validate Policies
        id: policy
        run: |
          set -euo pipefail

          KITFILE="kitfile-examples/${{ matrix.scenario.kitfile }}"
          RESULT_DIR="policy-results"
          mkdir -p "${RESULT_DIR}"

          evaluate_policy() {
            local policy_name="$1"
            local policy_file="$2"
            local query="$3"
            local output_file="${RESULT_DIR}/${policy_name}.json"

            opa eval --data "${policy_file}" \
              --input "${KITFILE}" \
              --format json "${query}" \
              | jq -c '.result[0].expressions[0].value // []' > "${output_file}"

            if [ "$(jq 'length' "${output_file}")" -gt 0 ]; then
              while IFS= read -r message; do
                echo "::error::${policy_name} policy failed - ${message}"
              done < <(jq -r '.[]' "${output_file}")
            fi
          }

          evaluate_policy "license" "policies/license-compliance.rego" "data.governance.licenses.deny"
          evaluate_policy "approval" "policies/approval-validation.rego" "data.governance.approvals.deny"
          evaluate_policy "bias" "policies/bias-monitoring.rego" "data.governance.bias.deny"
          evaluate_policy "security" "policies/security-thresholds.rego" "data.governance.security.deny"

          opa eval --input "${KITFILE}" \
            --format json "input.model.parameters.governance.scan_metrics" \
            | jq '.result[0].expressions[0].value // {}' > "${RESULT_DIR}/scan-metrics.json"

          jq -n \
            --arg scenario "${{ matrix.scenario.name }}" \
            --arg kitfile "${{ matrix.scenario.kitfile }}" \
            --arg git_sha "${{ github.sha }}" \
            --slurpfile license "${RESULT_DIR}/license.json" \
            --slurpfile approval "${RESULT_DIR}/approval.json" \
            --slurpfile bias "${RESULT_DIR}/bias.json" \
            --slurpfile security "${RESULT_DIR}/security.json" \
            --slurpfile scan_metrics "${RESULT_DIR}/scan-metrics.json" \
            '{
              scenario: $scenario,
              kitfile: $kitfile,
              git_sha: $git_sha,
              policy_results: {
                license: $license[0],
                approval: $approval[0],
                bias: $bias[0],
                security: $security[0]
              },
              scan_metrics: $scan_metrics[0],
              result: (
                if (($license[0] | length) +
                    ($approval[0] | length) +
                    ($bias[0] | length) +
                    ($security[0] | length)) == 0
                then "PASS"
                else "FAIL"
                end
              )
            }' > "${RESULT_DIR}/policy-summary.json"

          RESULT="$(jq -r '.result' "${RESULT_DIR}/policy-summary.json")"
          echo "result=${RESULT}" >> "${GITHUB_OUTPUT}"
          echo "policy_summary_path=${RESULT_DIR}/policy-summary.json" >> "${GITHUB_OUTPUT}"

      - name: Upload Policy Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-summary-${{ matrix.scenario.kitfile }}
          path: policy-results/policy-summary.json
      
      - name: Authenticate to Jozu Hub
        if: steps.policy.outputs.result == 'PASS'
        env:
          JOZU_USERNAME: ${{ secrets.JOZU_USERNAME }}
          JOZU_PASSWORD: ${{ secrets.JOZU_PASSWORD }}
        run: |
          echo "$JOZU_PASSWORD" | kit login jozu.ml -u "$JOZU_USERNAME" --password-stdin
      
      - name: Push to Jozu Hub
        if: steps.policy.outputs.result == 'PASS'
        run: |
          kit tag local/fraud:${{ github.sha }} jozu.ml/arnabchat2001/kitops-governance-demo:${{ github.sha }}
          kit tag local/fraud:${{ github.sha }} jozu.ml/arnabchat2001/kitops-governance-demo:latest
          
          kit push jozu.ml/arnabchat2001/kitops-governance-demo:${{ github.sha }}
          kit push jozu.ml/arnabchat2001/kitops-governance-demo:latest
          
          echo "Pushed to: https://jozu.ml/arnabchat2001/kitops-governance-demo"

      - name: Setup Cosign
        if: steps.policy.outputs.result == 'PASS'
        uses: sigstore/cosign-installer@v3.7.0

      - name: Authenticate Cosign to Jozu Hub
        if: steps.policy.outputs.result == 'PASS'
        env:
          JOZU_USERNAME: ${{ secrets.JOZU_USERNAME }}
          JOZU_PASSWORD: ${{ secrets.JOZU_PASSWORD }}
        run: |
          echo "$JOZU_PASSWORD" | cosign login jozu.ml -u "$JOZU_USERNAME" --password-stdin

      - name: Attest Governance Results
        if: steps.policy.outputs.result == 'PASS'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          IMAGE_REF="jozu.ml/arnabchat2001/kitops-governance-demo:${{ github.sha }}"
          cosign attest --yes \
            --predicate "${{ steps.policy.outputs.policy_summary_path }}" \
            --type "https://jozu.com/attestations/kitops-governance/v1" \
            "${IMAGE_REF}"

          echo "Created governance attestation for ${IMAGE_REF}"
      
      - name: Block Deployment
        if: steps.policy.outputs.result == 'FAIL'
        run: |
          echo "::error::Deployment blocked due to policy violations"
          exit 1
